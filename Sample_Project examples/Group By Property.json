[{"id":"6bf5d689.db2d88","type":"tab","label":"Group By Property","disabled":false,"info":"Group objects by metadata property"},{"id":"ed5f5f51.f8335","type":"inject","z":"6bf5d689.db2d88","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":141.1041717529297,"y":342.3541564941406,"wires":[["f405507c.da268"]]},{"id":"f405507c.da268","type":"function","z":"6bf5d689.db2d88","name":"MAIN INPUTS","func":"// INPUTS\n\nteamspace = \"***\";  // make sure you have permissions to acces this teamspace\nmodelID = \"***\";    // make sure you have permissions to acces this model or federation\n\n\n// ignore the rest\n\ntry{\n    flow.set(\"teamspace\", teamspace);\n}catch(error){\n    node.error(\"Missing teamspace\", msg);\n    return;\n}\ntry{\n    flow.set(\"modelID\", modelID);\n}catch(error){\n    node.error(\"Missing modelID\", msg);\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":173.82066345214844,"y":184.42135620117188,"wires":[["cd5baa17.5ea028"]]},{"id":"4394254c.52ee4c","type":"http request","z":"6bf5d689.db2d88","name":"","method":"POST","ret":"obj","url":"{{{topic}}}","tls":"","x":473.60418701171875,"y":164.85415649414062,"wires":[["e04f22d7.009c3"]]},{"id":"e04f22d7.009c3","type":"function","z":"6bf5d689.db2d88","name":"cookie","func":"var cookies = msg.responseCookies;\n\ntry{\n    cookies[\"connect.sid\"];\n}catch(error){\n    node.error(\"Invalid username or password\", msg);\n    return;\n}\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": \"connect.sid=\" + cookies[\"connect.sid\"][\"value\"]\n};\n\nflow.set(\"cookie\",msg.headers[\"Cookie\"]);\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":476.15985107421875,"y":216.6060791015625,"wires":[["e58f74b0.425f18","55624772.d37d28"]]},{"id":"cd5baa17.5ea028","type":"function","z":"6bf5d689.db2d88","name":"header","func":"try{\n    test = global.get(\"username\")[0];\n}catch(error){\n    node.error(\"Login error - login at http://localhost:1880/ui/#/0\", msg);\n    return;\n}\ntry{\n    test = global.get(\"password\")[0];\n}catch(error){\n    node.error(\"Login error - login at http://localhost:1880/ui/#/0\", msg);\n    return;\n}\n\n\nmsg.payload = {\n \"username\": global.get(\"username\"), \n \"password\": global.get(\"password\")\n};\n\nmsg.topic = \"https://api1.www.3drepo.io/api/login\";\n\nmsg.headers = {'content-type':'application/json'};\n\nreturn msg;","outputs":1,"noerr":0,"x":475.5644226074219,"y":115.9920425415039,"wires":[["4394254c.52ee4c"]]},{"id":"e42597c9.d32448","type":"comment","z":"6bf5d689.db2d88","name":"login","info":"","x":477.47576904296875,"y":69.06598663330078,"wires":[]},{"id":"6e85dbae.bd9ae4","type":"function","z":"6bf5d689.db2d88","name":"API call","func":"cookie = flow.get(\"cookie\");\nvar calls = [];\n\nmsg.headers = {\n    \"content-type\": \"application/json\",\n    \"Cookie\": cookie\n};\n\nif(msg.inputs.allRev){\n    try{\n        var test = flow.get(\"revisions\").length;\n    }catch(error){\n        node.error(\"Missing revisions\", msg);\n        return;\n    }\n    for (var i = 0; i < flow.get(\"revisions\").length; i++) {\n        for (var prop in msg.inputs.filter) {\n            calls.push(\"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/revision/\" + flow.get(\"revisions\")[i]._id + \"/meta/findObjsWith/\" + prop + \".json\");\n        }\n    }\n}else{\n    for (var prop in msg.inputs.filter) {\n        calls.push(\"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/revision/master/head/meta/findObjsWith/\" + prop + \".json\");\n    }\n}\n\nmsg.payload = calls;\n\nreturn msg;","outputs":"1","noerr":0,"x":769.8542175292969,"y":148.60413360595703,"wires":[["301c2aaf.6160a6"]]},{"id":"301c2aaf.6160a6","type":"split","z":"6bf5d689.db2d88","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":773.9993591308594,"y":196.77680206298828,"wires":[["ce05523.90bb6b"]]},{"id":"ce05523.90bb6b","type":"http request","z":"6bf5d689.db2d88","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":766.5514831542969,"y":248.74224090576172,"wires":[["53d8ff12.c3778"]]},{"id":"53d8ff12.c3778","type":"join","z":"6bf5d689.db2d88","name":"","mode":"auto","build":"string","property":"payload","propertyType":"msg","key":"topic","joiner":"\\n","joinerType":"str","accumulate":"false","timeout":"","count":"","x":770.2581481933594,"y":297.12520599365234,"wires":[["8566e3c3.0c2b4"]]},{"id":"61e21f34.f9efd","type":"function","z":"6bf5d689.db2d88","name":"merge","func":"if(msg.inputs.allRev){\n    revisions = flow.get(\"revisions\");\n    merged = [];\n    \n    // partition API call results by revision\n    var rev = []\n    while (msg.payload.length > 0) {\n        rev.push(msg.payload.splice(0, Object.keys(msg.inputs.filter).length)); // this works\n    }\n\n    // get meta GUIDs, IFC GUIDs\n    for (var i = 0; i < rev.length; i++) {\n        merged[i] = [];\n        for (var j in rev[i][0][\"data\"]) {      // IfcGUID\n            for (var l = 1; l < rev[i].length; l++) {       // loop through filter\n                var property = Object.keys(msg.inputs.filter)[l];\n                var filter = msg.inputs.filter[Object.keys(msg.inputs.filter)[l]];\n                for (var k in rev[i][l][\"data\"]) {\n                    // if (rev[i][1][\"data\"][j] !== undefined && rev[i][0][\"data\"][j][\"_id\"] === rev[i][1][\"data\"][k][\"_id\"]) {\n                    if (rev[i][0][\"data\"][j][\"_id\"] === rev[i][l][\"data\"][k][\"_id\"]) {      // if meta IDs match create filtered object\n                        o = {};\n                        o.metaID = rev[i][0][\"data\"][j][\"_id\"];\n                        o.IFCGUID = rev[i][0][\"data\"][j][\"metadata\"][\"value\"];\n                        o.property = property;\n                        o.value = rev[i][l][\"data\"][k][\"metadata\"][\"value\"];\n                        o.timestamp = Date.parse(revisions[i].timestamp);\n                        o.parents = rev[i][0][\"data\"][j][\"parents\"];\n                        o.parents = rev[i][l][\"data\"][k][\"parents\"];        // ???\n                        merged[i].push(o)\n                    }\n                }\n            }\n        }\n    }\n    msg.payload = merged;\n    return msg;\n}else{\n    try{\n        var timestamp = Date.parse(flow.get(\"revisions\")[0].timestamp);\n    }catch(error){\n        node.error(\"Missing revisions\", msg);\n    return;\n    }\n    \n    merged = [];\n    \n    // partition API call results by revision\n    var rev = []\n    while (msg.payload.length > 0) {\n        rev.push(msg.payload.splice(0, Object.keys(msg.inputs.filter).length)); // this works\n    }\n    // node.send({payload:rev})\n    // get meta GUIDs, IFC GUIDs\n    for (var i = 0; i < rev.length; i++) {\n        merged[i] = [];\n        for (var j in rev[i][0][\"data\"]) {      // IfcGUID\n            for (var l = 1; l < rev[i].length; l++) {       // loop through filtered\n                var property = Object.keys(msg.inputs.filter)[l];\n                var filter = msg.inputs.filter[Object.keys(msg.inputs.filter)[l]];\n                for (var k in rev[i][l][\"data\"]) {\n                    var value = rev[i][l][\"data\"][k][\"metadata\"][\"value\"];\n                    \n                    // if (rev[i][1][\"data\"][j] !== undefined && rev[i][0][\"data\"][j][\"_id\"] === rev[i][1][\"data\"][k][\"_id\"]) {\n                    if (rev[i][0][\"data\"][j][\"_id\"] === rev[i][l][\"data\"][k][\"_id\"]) {      // if meta IDs match create filtered object\n                        \n                        if (filter.length === 0){\n                            o = {};\n                            o.metaID = rev[i][0][\"data\"][j][\"_id\"];\n                            o.IFCGUID = rev[i][0][\"data\"][j][\"metadata\"][\"value\"];\n                            o.property = property;\n                            o.value = value;\n                            o.timestamp = timestamp;\n                            o.parents = rev[i][0][\"data\"][j][\"parents\"];\n                            o.parents = rev[i][l][\"data\"][k][\"parents\"];        // ???\n                            merged[i].push(o)\n                        }else{\n                            if(filter[0] === true && value.search(filter[1]) > -1){\n                                o = {};\n                                o.metaID = rev[i][0][\"data\"][j][\"_id\"];\n                                o.IFCGUID = rev[i][0][\"data\"][j][\"metadata\"][\"value\"];\n                                o.property = property;\n                                o.value = value;\n                                o.timestamp = timestamp;\n                                o.parents = rev[i][0][\"data\"][j][\"parents\"];\n                                o.parents = rev[i][l][\"data\"][k][\"parents\"];        // ???\n                                merged[i].push(o);\n                            }else{\n                                // node.send({payload:value})\n                                for(var m=1; m<filter.length; m++){\n                                    if(filter[m] === value){\n                                    o = {};\n                                    o.metaID = rev[i][0][\"data\"][j][\"_id\"];\n                                    o.IFCGUID = rev[i][0][\"data\"][j][\"metadata\"][\"value\"];\n                                    o.property = property;\n                                    o.value = value;\n                                    o.timestamp = timestamp;\n                                    o.parents = rev[i][0][\"data\"][j][\"parents\"];\n                                    o.parents = rev[i][l][\"data\"][k][\"parents\"];        // ???\n                                    merged[i].push(o);\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n    msg.payload = merged;\n    return msg;\n}\n\n","outputs":1,"noerr":0,"x":772.3920288085938,"y":396.7420349121094,"wires":[["262a7aae.43cd66"]]},{"id":"46ccbb68.8e2074","type":"comment","z":"6bf5d689.db2d88","name":"filter","info":"keep Ifc GUID always as first item","x":765.4098205566406,"y":57.493019104003906,"wires":[]},{"id":"8566e3c3.0c2b4","type":"function","z":"6bf5d689.db2d88","name":"if fed (filters)","func":"var o = [];\n\nfor (var i=0; i < msg.payload.length; i++) {\n    if (msg.payload[i] !== undefined) {\n        if (msg.payload[i].subModels !== undefined) {\n            var obj = {};\n            var temp = [];\n            for (var j = 0; j < msg.payload[i].subModels.length; j++) {\n                for (var k = 0; k < msg.payload[i].subModels[j].data.length; k++) {\n                    // merge data arrays as per API calls \n                    temp.push(msg.payload[i].subModels[j].data[k])\n                }\n            }\n            obj.data = temp;\n            o.push(obj);\n        } else {\n            return msg;\n        }\n    }\n}\n\nmsg.payload = o;\n\nreturn msg","outputs":1,"noerr":0,"x":765.5489196777344,"y":346.6596374511719,"wires":[["61e21f34.f9efd"]]},{"id":"e58f74b0.425f18","type":"function","z":"6bf5d689.db2d88","name":"INPUTS","func":"// INPUTS:\n\nfilter = {\n    // IfcGUID is a default value, keep always as first item. Use Item:GUID for models uploaded with Navis plugin\n    \"IFC%20GUID\": [], \n    // add custom filters below\n    \"Zone%20Number\": []\n}\n\nallRevisions = false;\n\n\n// ignore the rest\n\nmsg.inputs = {};\nmsg.inputs.filter = filter;\nmsg.inputs.allRev = allRevisions;\n\nreturn msg;","outputs":1,"noerr":0,"x":760.3727722167969,"y":104.12268829345703,"wires":[["6e85dbae.bd9ae4"]]},{"id":"5aed6813.36e448","type":"comment","z":"6bf5d689.db2d88","name":"group by value","info":"set property in \"filter\"\ninput from \"filter\" proto-node\noutput to \"create group\"","x":1104.8541259765625,"y":56.10413360595703,"wires":[]},{"id":"262a7aae.43cd66","type":"function","z":"6bf5d689.db2d88","name":"group by property value","func":"var group = {};\n\nfor(var i=0; i<msg.payload.length; i++){\n    for(var j=0; j<msg.payload[i].length; j++){\n        var prop = String(msg.payload[i][j].value);\n        if(!group.hasOwnProperty(prop)){\n            group[prop] = [];\n        }\n        group[prop] = group[prop].concat(msg.payload[i][j].parents);\n    }\n}\n\nmsg.payload = group;\n\nreturn msg;","outputs":1,"noerr":0,"x":1099.8541259765625,"y":101.1874771118164,"wires":[["a3e4e8e.36ef318"]]},{"id":"a3e4e8e.36ef318","type":"split","z":"6bf5d689.db2d88","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":1114.8541259765625,"y":154.72916412353516,"wires":[["84c1ef26.75b46"]]},{"id":"dd760a14.99e878","type":"http request","z":"6bf5d689.db2d88","name":"","method":"POST","ret":"obj","url":"{{{topic}}}","tls":"","x":1094.8541259765625,"y":458.6041564941406,"wires":[[]]},{"id":"dd4ee7e.a87d818","type":"function","z":"6bf5d689.db2d88","name":"group API call","func":"var cookie = flow.get(\"cookie\");\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.topic = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/groups\";\n\nvar group = {};\ngroup.name = msg.inputs.groupName ;\ngroup.description = msg.inputs.desc;\ngroup.author = global.get(\"username\"); \ngroup.createdAt = Date.now();\ngroup.color = msg.inputs.colour;\ngroup.objects = msg.payload;\n\nmsg.payload = group;\n\nreturn msg;","outputs":1,"noerr":0,"x":1093.5567626953125,"y":403.7953796386719,"wires":[["dd760a14.99e878"]]},{"id":"7b61a520.217cec","type":"function","z":"6bf5d689.db2d88","name":"shared IDs","func":"function getKeyByValue(object, value) {\n    return Object.keys(object).find(key => object[key] === value);\n}\n\nvar sharedIDs = [];\nIDmap = flow.get(\"IDmap\");\ntry{\n    var test = IDmap.length;\n}catch(error){\n    node.error(\"Missing ID map\", msg);\n    return;\n}\n\nif (IDmap !== undefined) {\n    if (IDmap.subModels !== undefined) {        // if federation\n        for (var i = 0; i < msg.payload.length; i++) {\n            for (var j = 0; j < IDmap.subModels.length; j++) {\n                var key = getKeyByValue(IDmap.subModels[j].idMap, msg.payload[i]);\n                if (key !== undefined) {\n                    sharedIDs.push(msg.payload[i]);\n                    break;\n                }\n            }\n        }\n    } else {\n        for (var i = 0; i < msg.payload.length; i++) {\n            var key = getKeyByValue(IDmap.idMap, msg.payload[i]);\n            sharedIDs.push(msg.payload[i]);\n        }\n    }\n}\n\nmsg.payload = [{\n    \"account\": flow.get(\"teamspace\"),\n    \"model\": flow.get(\"modelID\"),\n    \"shared_ids\": sharedIDs,\n}];\n\nreturn msg;","outputs":1,"noerr":0,"x":1099.6558227539062,"y":344.8487854003906,"wires":[["dd4ee7e.a87d818"]]},{"id":"726fb208.43d0cc","type":"comment","z":"6bf5d689.db2d88","name":"create group","info":"","x":1096.3642272949219,"y":244.05721282958984,"wires":[]},{"id":"84c1ef26.75b46","type":"function","z":"6bf5d689.db2d88","name":"INPUTS","func":"// INPUTS\n\ngroupName =  (msg.topic) ? msg.topic : \"Group\";\ndescription = msg.payload.length + \" from Node-RED\";\ncolour = [parseInt(Math.random()*255),parseInt(Math.random()*255),parseInt(Math.random()*255)];\n\n\n// ignore the rest\n\nmsg.inputs = {};\nmsg.inputs.groupName = groupName;\nmsg.inputs.desc = description;\nmsg.inputs.colour = colour;\n\nreturn msg;","outputs":1,"noerr":0,"x":1094.3778991699219,"y":298.4598617553711,"wires":[["7b61a520.217cec"]]},{"id":"55624772.d37d28","type":"function","z":"6bf5d689.db2d88","name":"revisions API","func":"cookie = flow.get(\"cookie\");\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.payload = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/\" + \"revisions.json\"\n\nreturn msg;","outputs":1,"noerr":0,"x":473.60418701171875,"y":411.1041564941406,"wires":[["5fe0010e.8493e"]]},{"id":"5fe0010e.8493e","type":"http request","z":"6bf5d689.db2d88","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":473.5937805175781,"y":460.58330631256104,"wires":[["e70907c8.e1d968"]]},{"id":"e70907c8.e1d968","type":"function","z":"6bf5d689.db2d88","name":"OUTPUTS","func":"// all revisions\n\nflow.set(\"revisions\", msg.payload);\n\nreturn {payload:\"\"};\n\n\n// uncomment and specify subset of revisions below\n\n// flow.set(\"revisions\", msg.payload.slice(0,10));\n","outputs":1,"noerr":0,"x":484.60072326660156,"y":509.32639026641846,"wires":[["5cdb2d10.d00144"]]},{"id":"4604b182.e10de","type":"comment","z":"6bf5d689.db2d88","name":"revisions","info":"get all revisions of a model\n\nto choose only subset of revisions use:\nmsg.payload.slice(0,3)\n\nplace after login","x":475.85418701171875,"y":364.57984924316406,"wires":[]},{"id":"5cdb2d10.d00144","type":"function","z":"6bf5d689.db2d88","name":"ID map call","func":"cookie = flow.get(\"cookie\");\n\ntry{\n    revID = flow.get(\"revisions\")[0]._id;\n}catch(error){\n    node.error(\"Missing revisions\", msg);\n    return;\n}\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.payload = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/revision/\" + revID + \"/idmap.json\";\n\nreturn msg;\n","outputs":1,"noerr":0,"x":482.35418701171875,"y":648.6041870117188,"wires":[["4fd4e46f.4746dc"]]},{"id":"4fd4e46f.4746dc","type":"http request","z":"6bf5d689.db2d88","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":482.6276035308838,"y":702.1353645324707,"wires":[["4bca97ba.3a87e8"]]},{"id":"79574b7e.22f664","type":"comment","z":"6bf5d689.db2d88","name":"ID map","info":"","x":479.26072120666504,"y":602.7575874328613,"wires":[]},{"id":"4bca97ba.3a87e8","type":"function","z":"6bf5d689.db2d88","name":"set ID map","func":"flow.set(\"IDmap\", msg.payload);","outputs":1,"noerr":0,"x":478.01072120666504,"y":756.4241218566895,"wires":[[]]},{"id":"679c1f37.0a478","type":"comment","z":"6bf5d689.db2d88","name":"how to","info":"log in at http://localhost:1880/ui/#/0 or http://yourVPS:1880/ui/#/0\nset your teamspace and model ID of Lego_House_Federation in MAIN INPUTS\ndeploy\nopen or reload Lego_House_Federation in 3D Repo, see the results in Groups card\nchange property in filter INPUTS to create different groups","x":152.2083282470703,"y":89.3124771118164,"wires":[]},{"id":"175493f2.4dbfac","type":"ui_text_input","z":"6bf5d689.db2d88","name":"","label":"Username","group":"37a7cb2f.c8e1e4","order":1,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","x":162.3542022705078,"y":529.8541946411133,"wires":[["f81d682d.1c8d28"]]},{"id":"3ea2cb50.aaa7a4","type":"ui_text_input","z":"6bf5d689.db2d88","name":"","label":"Password","group":"37a7cb2f.c8e1e4","order":2,"width":0,"height":0,"passthru":false,"mode":"password","delay":300,"topic":"","x":161.3818817138672,"y":616.2474670410156,"wires":[["9328be30.32bd6"]]},{"id":"f81d682d.1c8d28","type":"function","z":"6bf5d689.db2d88","name":"username","func":"global.set(\"username\",msg.payload);","outputs":1,"noerr":0,"x":166.1041717529297,"y":573.8863143920898,"wires":[[]]},{"id":"9328be30.32bd6","type":"function","z":"6bf5d689.db2d88","name":"password","func":"global.set(\"password\",msg.payload);\n\n","outputs":1,"noerr":0,"x":159.4418487548828,"y":657.9054565429688,"wires":[[]]},{"id":"9a1745f9.e9e9d8","type":"comment","z":"6bf5d689.db2d88","name":"login details","info":"input your login details in dashboard at\n\nhttp://localhost:1880/ui/#/0\n\nset as global variable hence use only once for multiple flows","x":158.02085876464844,"y":479.48380279541016,"wires":[]},{"id":"37a7cb2f.c8e1e4","type":"ui_group","z":"","name":"Log In","tab":"bcea93cd.2aefd","order":1,"disp":true,"width":"6"},{"id":"bcea93cd.2aefd","type":"ui_tab","z":"","name":"Log In","icon":"dashboard","order":1}]