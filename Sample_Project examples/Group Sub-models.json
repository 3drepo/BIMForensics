[{"id":"49d94520.fb4114","type":"tab","label":"Group Sub-models","disabled":false,"info":"Groups sub-models in federation for colour overrides"},{"id":"296a49fc.ac73b6","type":"inject","z":"49d94520.fb4114","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":true,"x":137.3541717529297,"y":354.8541564941406,"wires":[["cb621e06.870c88"]]},{"id":"cb621e06.870c88","type":"function","z":"49d94520.fb4114","name":"MAIN INPUTS","func":"// INPUTS\n\nteamspace = \"***\";  // make sure you have permissions to acces this teamspace\nmodelID = \"***\";    // make sure you have permissions to acces this model or federation\n\n\n// ignore the rest\n\ntry{\n    flow.set(\"teamspace\", teamspace);\n}catch(error){\n    node.error(\"Missing teamspace\", msg);\n    return;\n}\ntry{\n    flow.set(\"modelID\", modelID);\n}catch(error){\n    node.error(\"Missing modelID\", msg);\n    return;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":170.07066345214844,"y":196.92135620117188,"wires":[["b41957ae.6fce4"]]},{"id":"9f3e84fd.4f6fb","type":"http request","z":"49d94520.fb4114","name":"","method":"POST","ret":"obj","url":"{{{topic}}}","tls":"","x":469.85418701171875,"y":177.35415649414062,"wires":[["d031577e.2c9d2"]]},{"id":"d031577e.2c9d2","type":"function","z":"49d94520.fb4114","name":"cookie","func":"var cookies = msg.responseCookies;\n\ntry{\n    cookies[\"connect.sid\"];\n}catch(error){\n    node.error(\"Invalid username or password\", msg);\n    return;\n}\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": \"connect.sid=\" + cookies[\"connect.sid\"][\"value\"]\n};\n\nflow.set(\"cookie\",msg.headers[\"Cookie\"]);\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":472.40985107421875,"y":229.1060791015625,"wires":[["119b355.44e454b","ad619899.33ec","6a372601.7e5238"]]},{"id":"b41957ae.6fce4","type":"function","z":"49d94520.fb4114","name":"header","func":"try{\n    test = global.get(\"username\")[0];\n}catch(error){\n    node.error(\"Login error - login at http://localhost:1880/ui/#/0\", msg);\n    return;\n}\ntry{\n    test = global.get(\"password\")[0];\n}catch(error){\n    node.error(\"Login error - login at http://localhost:1880/ui/#/0\", msg);\n    return;\n}\n\n\nmsg.payload = {\n \"username\": global.get(\"username\"), \n \"password\": global.get(\"password\")\n};\n\nmsg.topic = \"https://api1.www.3drepo.io/api/login\";\n\nmsg.headers = {'content-type':'application/json'};\n\nreturn msg;","outputs":1,"noerr":0,"x":471.8144226074219,"y":128.4920425415039,"wires":[["9f3e84fd.4f6fb"]]},{"id":"1f13bffb.24edd","type":"comment","z":"49d94520.fb4114","name":"login","info":"","x":473.72576904296875,"y":81.56598663330078,"wires":[]},{"id":"78c7e343.facb34","type":"http request","z":"49d94520.fb4114","name":"","method":"POST","ret":"obj","url":"{{{topic}}}","tls":"","x":1091.1041259765625,"y":471.1041564941406,"wires":[[]]},{"id":"6f16eadd.3bd894","type":"function","z":"49d94520.fb4114","name":"group API call","func":"var cookie = flow.get(\"cookie\");\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.topic = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/groups\";\n\nvar group = {};\ngroup.name = msg.inputs.groupName ;\ngroup.description = msg.inputs.desc;\ngroup.author = global.get(\"username\"); \ngroup.createdAt = Date.now();\ngroup.color = msg.inputs.colour;\ngroup.objects = msg.payload;\n\nmsg.payload = group;\n\nreturn msg;","outputs":1,"noerr":0,"x":1089.8067626953125,"y":416.2953796386719,"wires":[["78c7e343.facb34"]]},{"id":"94a996f2.60ceb","type":"function","z":"49d94520.fb4114","name":"shared IDs","func":"function getKeyByValue(object, value) {\n    return Object.keys(object).find(key => object[key] === value);\n}\n\nvar sharedIDs = [];\nIDmap = flow.get(\"IDmap\");\ntry{\n    var test = IDmap.length;\n}catch(error){\n    node.error(\"Missing ID map\", msg);\n    return;\n}\n\nif (IDmap !== undefined) {\n    if (IDmap.subModels !== undefined) {        // if federation\n        for (var i = 0; i < msg.payload.length; i++) {\n            for (var j = 0; j < IDmap.subModels.length; j++) {\n                var key = getKeyByValue(IDmap.subModels[j].idMap, msg.payload[i]);\n                if (key !== undefined) {\n                    sharedIDs.push(msg.payload[i]);\n                    break;\n                }\n            }\n        }\n    } else {\n        for (var i = 0; i < msg.payload.length; i++) {\n            var key = getKeyByValue(IDmap.idMap, msg.payload[i]);\n            sharedIDs.push(msg.payload[i]);\n        }\n    }\n}\n\nmsg.payload = [{\n    \"account\": flow.get(\"teamspace\"),\n    \"model\": flow.get(\"modelID\"),\n    \"shared_ids\": sharedIDs,\n}];\n\nreturn msg;","outputs":1,"noerr":0,"x":1095.9058227539062,"y":357.3487854003906,"wires":[["6f16eadd.3bd894"]]},{"id":"d37045c1.f51cf","type":"comment","z":"49d94520.fb4114","name":"create group","info":"","x":1092.6142272949219,"y":256.55721282958984,"wires":[]},{"id":"f6299ec9.caa97","type":"function","z":"49d94520.fb4114","name":"INPUTS","func":"// INPUTS\n\ngroupName =  (msg.topic) ? msg.topic : \"Group\";\ndescription = msg.payload.length + \" from Node-RED\";\ncolour = [parseInt(Math.random()*255),parseInt(Math.random()*255),parseInt(Math.random()*255)];\n\n\n// ignore the rest\n\nmsg.inputs = {};\nmsg.inputs.groupName = groupName;\nmsg.inputs.desc = description;\nmsg.inputs.colour = colour;\n\nreturn msg;","outputs":1,"noerr":0,"x":1090.6278991699219,"y":310.9598617553711,"wires":[["94a996f2.60ceb"]]},{"id":"119b355.44e454b","type":"function","z":"49d94520.fb4114","name":"revisions API","func":"cookie = flow.get(\"cookie\");\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.payload = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/\" + \"revisions.json\"\n\nreturn msg;","outputs":1,"noerr":0,"x":469.85418701171875,"y":423.6041564941406,"wires":[["a07232ef.662bd"]]},{"id":"a07232ef.662bd","type":"http request","z":"49d94520.fb4114","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":469.8437805175781,"y":473.08330631256104,"wires":[["726b9c5d.1d00c4"]]},{"id":"726b9c5d.1d00c4","type":"function","z":"49d94520.fb4114","name":"OUTPUTS","func":"// all revisions\n\nflow.set(\"revisions\", msg.payload);\n\n\n// uncomment and specify subset of revisions below\n\n// flow.set(\"revisions\", msg.payload.slice(0,10));\n","outputs":1,"noerr":0,"x":480.85072326660156,"y":521.8263902664185,"wires":[[]]},{"id":"3ab85d19.a4e112","type":"comment","z":"49d94520.fb4114","name":"revisions","info":"get all revisions of a model\n\nto choose only subset of revisions use:\nmsg.payload.slice(0,3)\n\nplace after login","x":472.10418701171875,"y":377.07984924316406,"wires":[]},{"id":"ad619899.33ec","type":"function","z":"49d94520.fb4114","name":"ID map call","func":"cookie = flow.get(\"cookie\");\n\ntry{\n    revID = flow.get(\"revisions\")[0]._id;\n}catch(error){\n    node.error(\"Missing revisions\", msg);\n    return;\n}\n\nmsg.headers = {\n \"content-type\":\"application/json\",\n \"Cookie\": cookie\n};\n\nmsg.payload = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \"/revision/\" + revID + \"/idmap.json\";\n\nreturn msg;\n","outputs":1,"noerr":0,"x":761.1041870117188,"y":118.60416412353516,"wires":[["ee5a7547.e3d3"]]},{"id":"ee5a7547.e3d3","type":"http request","z":"49d94520.fb4114","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":761.3776035308838,"y":172.1353416442871,"wires":[["62bbeb1e.eb0bec","b80025af.5e93d8"]]},{"id":"f50d26ce.f1eb78","type":"comment","z":"49d94520.fb4114","name":"ID map","info":"","x":758.010721206665,"y":72.75756454467773,"wires":[]},{"id":"62bbeb1e.eb0bec","type":"function","z":"49d94520.fb4114","name":"set ID map","func":"flow.set(\"IDmap\", msg.payload);","outputs":1,"noerr":0,"x":756.760721206665,"y":226.42409896850586,"wires":[[]]},{"id":"d51a0294.1411","type":"comment","z":"49d94520.fb4114","name":"how to","info":"set your teamspace and model ID of Lego_House_Federation in MAIN INPUTS\ndeploy\nopen or reload Lego_House_Federation in 3D Repo, see the results in Groups card","x":148.4583282470703,"y":101.8124771118164,"wires":[]},{"id":"a0838ff0.9057d","type":"ui_text_input","z":"49d94520.fb4114","name":"","label":"Username","group":"cf04b7f0.6e0e5","order":1,"width":0,"height":0,"passthru":false,"mode":"text","delay":300,"topic":"","x":158.6042022705078,"y":542.3541946411133,"wires":[["65711ceb.82d5ec"]]},{"id":"ff1e3909.4e41e8","type":"ui_text_input","z":"49d94520.fb4114","name":"","label":"Password","group":"cf04b7f0.6e0e5","order":2,"width":0,"height":0,"passthru":false,"mode":"password","delay":300,"topic":"","x":157.6318817138672,"y":628.7474670410156,"wires":[["f166fb2e.88a71"]]},{"id":"65711ceb.82d5ec","type":"function","z":"49d94520.fb4114","name":"username","func":"global.set(\"username\",msg.payload);","outputs":1,"noerr":0,"x":162.3541717529297,"y":586.3863143920898,"wires":[[]]},{"id":"f166fb2e.88a71","type":"function","z":"49d94520.fb4114","name":"password","func":"global.set(\"password\",msg.payload);\n\n","outputs":1,"noerr":0,"x":155.6918487548828,"y":670.4054565429688,"wires":[[]]},{"id":"ee586fac.7882f","type":"comment","z":"49d94520.fb4114","name":"login details","info":"input your login details in dashboard at\n\nhttp://localhost:1880/ui/#/0\n\nset as global variable hence use only once for multiple flows","x":154.27085876464844,"y":491.98380279541016,"wires":[]},{"id":"d90db107.d605a","type":"function","z":"49d94520.fb4114","name":"set flow variables","func":"if(msg.payload.subModels){\n    flow.set(\"subModels\", msg.payload.subModels);\n}","outputs":1,"noerr":0,"x":754.8541870117188,"y":518.6041870117188,"wires":[[]]},{"id":"c29e12c7.472128","type":"http request","z":"49d94520.fb4114","name":"","method":"GET","ret":"obj","url":"{{{payload}}}","tls":"","x":757.3561401367188,"y":469.7977294921875,"wires":[["d90db107.d605a"]]},{"id":"6a372601.7e5238","type":"function","z":"49d94520.fb4114","name":"model settings","func":"cookie = flow.get(\"cookie\");\n\nmsg.headers = {\n    \"content-type\":\"application/json\",\n    \"Cookie\": cookie\n};\n\nmsg.payload = \"https://api1.www.3drepo.io/api/\" + flow.get(\"teamspace\") + \"/\" + flow.get(\"modelID\") + \".json\";\n\nreturn msg;","outputs":1,"noerr":0,"x":754.8605346679688,"y":422.35638427734375,"wires":[["c29e12c7.472128"]]},{"id":"fae2ef4c.b94ab","type":"comment","z":"49d94520.fb4114","name":"settings","info":"","x":757.2078552246094,"y":375.2945556640625,"wires":[]},{"id":"b80025af.5e93d8","type":"function","z":"49d94520.fb4114","name":"group by submodel","func":"var group = {};\nvar subModels = flow.get(\"subModels\")\n\ntry{\n    for(var i=0; i<msg.payload.subModels.length; i++){\n        for(var j=0; j<subModels.length; j++){\n            if(msg.payload.subModels[i].model === subModels[j].model){\n                var prop = subModels[j].name;\n            }\n        }\n        if(!group.hasOwnProperty(prop)){\n            group[prop] = [];\n        }\n        for(var j=0; j<Object.keys(msg.payload.subModels[i].idMap).length; j++){\n            group[prop].push(msg.payload.subModels[i].idMap[Object.keys(msg.payload.subModels[i].idMap)[j]]);\n        }\n    }\n}catch(error){\n    node.error(\"This is not federation\", msg);\n    return;\n}\n\nmsg.payload = group;\n\nreturn msg;","outputs":1,"noerr":0,"x":1094.8541259765625,"y":131.10415649414062,"wires":[["7ecddd58.190074"]]},{"id":"7ecddd58.190074","type":"split","z":"49d94520.fb4114","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"topic","x":1091.25,"y":186.56253051757812,"wires":[["f6299ec9.caa97"]]},{"id":"f842655f.290b3","type":"comment","z":"49d94520.fb4114","name":"group sub-models","info":"works for only federations\ninput from \"IDmap\" http request\noutput to \"create group\"","x":1088.75,"y":81.56253051757812,"wires":[]},{"id":"cf04b7f0.6e0e5","type":"ui_group","z":"","name":"Log In","tab":"a39f29b8.55b87","order":1,"disp":true,"width":"6"},{"id":"a39f29b8.55b87","type":"ui_tab","z":"","name":"Log In","icon":"dashboard","order":1}]